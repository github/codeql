name: Regenerate framework models

on:
  workflow_dispatch:
  schedule:
    - cron: "30 2 * * *"

jobs:
  regenerate-models:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        frameworks:
          [
            '{"slug":"apache/commons-io", ref:"8985de8fe74f6622a419b37a6eed0dbc484dc128"}',
          ]
    steps:
      - name: Clone self (github/codeql)
        uses: actions/checkout@v2
      - name: Setup CodeQL binaries
        uses: ./.github/actions/fetch-codeql
      - name: Clone repositories
        uses: actions/checkout@v2
        with:
          path: repos/${{ fromJSON(matrix.frameworks).ref }}
          ref: ${{ fromJSON(matrix.frameworks).ref }}
          repository: ${{ fromJSON(matrix.frameworks).slug }}
      - name: Build database
        env:
          SLUG: ${{ fromJSON(matrix.frameworks).slug }}
          REF: ${{ fromJSON(matrix.frameworks).ref }}
        run: |
          mkdir dbs
          cd repos/${REF}
          SHORTNAME=${SLUG//[^a-zA-Z0-9_]/}
          codeql database create --language=java ../../dbs/${SHORTNAME}
      - name: Regenerate models in-place
        env:
          SLUG: ${{ fromJSON(matrix.frameworks).slug }}
        run: |
          SHORTNAME=${SLUG//[^a-zA-Z0-9_]/}
          java/ql/src/utils/model-generator/RegenerateModels.py "${SLUG}" dbs/${SHORTNAME}
      - name: Stage changes
        run: |
          find java -name "*.qll" -print0 | xargs -0 git add
          git status
          git diff --cached > models.patch
      - uses: actions/upload-artifact@v2
        with:
          name: patch
          path: models.patch
          retention-days: 7
